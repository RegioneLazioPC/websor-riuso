/*! Built with http://stenciljs.com */
const{h:t}=window.mapper;class i{constructor(){this.list=[],this.selector="",this.bottomOffset=0,this.virtualRatio=3,this.changed=[],this.position=0,this.parentScrollHeight=0,this.vscrollOffsetTop=0,this.contentOffsetTop=0,this.elementOffsetTop=0,this.infinateOn=!0,this.infinateFinally=!1,this.totalHeight=0,this.listDimensions=[],this.initRender=!1,this.toNextUpdateDimensions=!1,this.stackToDelete=[],this.scrollEventDispatch=(()=>void 0)}dataDidChangeHandler(t,i){if(i.length>0){let s=i.filter(i=>0==t.filter(t=>t.index==i.index).length);s.length>0&&s.map(t=>{this._deleteDimension(t.index)})}this.list.map((t,i)=>{t.index||(t.index=i)}),this.updateVirtual(!0),this._setDimensions()}componentDidLoad(){this._setDefParams(),this.selector.length>0?this.parentScroll=this.el.closest("."+this.selector):this.parentScroll=this.el.querySelector(".vscroll"),this.parentScrollHeight=this.parentScroll.offsetHeight,this.contentOffsetTop=this.parentScroll?this.parentScroll.offsetTop:0,this.contentEl=this.el.querySelector(".vscroll-content");let t=this.el.querySelector(".vscroll");this.vscrollOffsetTop=t?t.offsetTop:0,this.scrollEventDispatch=this.parentScroll.addEventListener("scroll",t=>{this.parentScroll.scrollTop-this.vscrollOffsetTop-this.elementOffsetTop+this.parentScrollHeight<0||(this.position=this.parentScroll.scrollTop-this.vscrollOffsetTop-this.elementOffsetTop,this.updateVirtual())},!1)}unwatch(){this.parentScroll&&this.parentScroll.removeEventListener("scroll",this._listener)}_listener(){this.position=this.parentScroll.scrollTop-this.vscrollOffsetTop,this.updateVirtual()}componentDidUnload(){this.unwatch(),this.scrollEventDispatch&&(this.scrollEventDispatch(),this.scrollEventDispatch=null)}componentWillLoad(){}_setDefParams(){this.first=null,this.last=null,this.listDimensions=[],this.totalHeight=0,this.position=0,this.infinateOn=!0,this.infinateFinally=!1}updateVirtual(t=!1){let i=this.first?this.first.rindex:0,s=this.last?this.last.rindex:0;if(this.first=this.listDimensions.filter(t=>this.position>=t.start&&this.position<t.end)[0],this.last=this.listDimensions.filter(t=>this.position+this.parentScroll.clientHeight>=t.start&&this.position+this.parentScroll.clientHeight<t.end)[0],this.last||(this.last=this.listDimensions[this.listDimensions.length-1]),this.first&&this.last){let e=this.last.rindex+this.virtualRatio>=this.list.length?this.list.length:this.last.rindex+this.virtualRatio,l=this.first.rindex-this.virtualRatio<0?0:this.first.rindex-this.virtualRatio;e==this.list.length&&this.totalHeight-this.position-this.parentScrollHeight<0&&(l=i-this.virtualRatio<0?0:i-this.virtualRatio,this.first=this.listDimensions.filter(t=>t.rindex==i)[0]);let n=[];this.list.length>0&&(n=this.list.slice(l,e)),(i!=this.first.rindex||s!=this.last.rindex||t)&&(requestAnimationFrame(()=>{let i=this.listDimensions.filter(t=>t.rindex==l)[0];i&&(this.contentEl.style.transform="translateY("+i.start+"px)",this.contentEl.style.webkitTransform="translateY("+i.start+"px)"),this.update.emit(n),t&&(this.changed=[...this.changed,""])}),this.changed=[...this.changed,""])}else if(this.list.length>0){let t=this.list.slice(0,20);this.update.emit(t),this.changed=[...this.changed,""]}this.last&&this.last.rindex>=this.list.length-1-this.bottomOffset&&this.infinateOn&&!this.infinateFinally&&this.list.length>0&&(this.infinateOn=!1,this.toBottom.emit(this.position))}setInfinateOn(){this.infinateOn=!0}setInfinateFinally(){this.infinateFinally=!0}clear(){this._setDefParams(),requestAnimationFrame(()=>{this.list=[],this.contentEl.style.transform="translateY(0px)",this.contentEl.style.webkitTransform="translateY(0px)",this.changed=[...this.changed,""]})}scrollToNode(t,i,s=0){if(this.parentScroll)if(t<=this.listDimensions.length-1){let e=this.listDimensions.filter(i=>i.rindex==t)[0];this._scrollTo(e.start+s,i)}else this._scrollToIndex(t)}_scrollToIndex(t){setTimeout(()=>{this.parentScroll.scrollTop=this.parentScroll.scrollTop+100,this.first&&this.first.rindex===t||this._scrollToIndex(t)},10)}_scrollTo(t,i){if(i<=0)return;let s=(t-this.parentScroll.scrollTop)/i*10;setTimeout(()=>{this.parentScroll.scrollTop=this.parentScroll.scrollTop+s,this.parentScroll.scrollTop!==t&&this._scrollTo(t,i-10)},10)}_setDimensions(){let t=this.totalHeight;this.toNextUpdateDimensions&&(this.listDimensions=[]),this.toNextUpdateDimensions=!1;let i=this.el.querySelectorAll(".virtual-slot .virtual-item");if(i.length>0)for(let t=0;t<=i.length-1;t++){let s=i[t],e=s.id;this.listDimensions.filter(t=>t.rindex==e)[0]||(this._addNewDimensionToEnd(s.offsetHeight,e),this.totalHeight=this.listDimensions[this.listDimensions.length-1].end)}return this.totalHeight!=t}_addNewDimensionToEnd(t,i){let s=this.listDimensions.length>0?this.listDimensions[this.listDimensions.length-1].end:0;this.listDimensions.push({height:t,start:s,end:s+t,rindex:parseInt(i)})}_deleteDimension(t){let i=this.listDimensions.filter(i=>i.rindex==t)[0];if(i){i.start=0,i.end=0;for(let s=t+1;s<=this.listDimensions.length-1;s++)this.listDimensions[s].start=this.listDimensions[s].start-i.height,this.listDimensions[s].end=this.listDimensions[s].end-i.height;let s=this.listDimensions.filter(t=>t.end>0);0==s.length?this.totalHeight=0:this.totalHeight=s[s.length-1].end}}refresh(){this.toNextUpdateDimensions=!0}_testDimensions(){let t=this.el.querySelector(".virtual-slot").childNodes;if(t.length>0)for(let i=0;i<=t.length-1;i++){let s=t[i],e=s.id,l=this.listDimensions.filter(t=>t.rindex==e)[0];l&&(l.height,s.offsetHeight)}}componentDidUpdate(){let t=this._setDimensions();this.initRender?(t&&(this.changed=[...this.changed,""]),this._testDimensions()):(this.initRender=!0,this.selector.length>0&&(this.elementOffsetTop=this.el.offsetTop),this.updateVirtual())}render(){return t("div",{class:"vscroll "+(this.selector.length>0?"external ":"inner ")+(this.infinateFinally?"infinate-finally ":" ")+(0==this.list.length?"cleared":"")},t("div",{class:"vscroll-back",style:{height:this.totalHeight+"px"}}),t("div",{class:"vscroll-content "+(this.selector.length>0?"external":"inner")},t("slot",{name:"virtual"})),t("slot",{name:"loader"}))}static get is(){return"virtual-scroll"}static get properties(){return{bottomOffset:{type:Number,attr:"bottom-offset"},changed:{state:!0},clear:{method:!0},el:{elementRef:!0},list:{type:"Any",attr:"list",watchCallbacks:["dataDidChangeHandler"]},refresh:{method:!0},scrollToNode:{method:!0},selector:{type:String,attr:"selector"},setInfinateFinally:{method:!0},setInfinateOn:{method:!0},virtualRatio:{type:Number,attr:"virtual-ratio"}}}static get events(){return[{name:"toBottom",method:"toBottom",bubbles:!0,cancelable:!0,composed:!0},{name:"update",method:"update",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return".vscroll.inner{overflow-y:auto;height:100%}.vscroll.external{overflow-y:hidden}.vscroll{overflow-x:hidden;position:relative;display:block}.vscroll .vscroll-back{width:1px;opacity:0}.vscroll .vscroll-content{top:0;left:0;width:100%;position:absolute}.vscroll .vscroll-content.inner{height:100%}.infinate-finally div[slot=loader]{visibility:hidden}.cleared div[slot=loader]{display:none}.virtual-slot{max-height:100px}virtual-scroll{height:100%;display:block}"}}export{i as VirtualScroll};